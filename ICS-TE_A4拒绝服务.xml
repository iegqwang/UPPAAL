<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>// 液位传感器
bool l=false; //低液位
bool m=false; //中液位
bool h=false; //高液位

bool s=false; //总开关

int q=0; //产检传感器，&gt;=90 产品合格
int w=0; //搅拌器转速，0停止，100正常工作

bool x=false; //进料口A
bool y=false; //进料口B
bool z=false; //搅拌器工作状态

bool u=false; //产品阀
bool v=false; //废品阀
//bool f=false;  //产品排出状态，正常排出/排出异常

//全局时钟
clock gc;

//通道
chan Start;
broadcast chan Stop;

//预设时间
const int preheatingTime=100;
const int feedingTime=5000;
const int inspectionTime=10000;

//开关标志位，防止广播通道自主更新
bool flag=false;</declaration>
	<template>
		<name>Admin</name>
		<declaration>//局部时钟
clock c;</declaration>
		<location id="id0" x="-85" y="-50">
			<name x="-102" y="-93">Switch</name>
		</location>
		<init ref="id0"/>
		<transition>
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="assignment" x="-127" y="59">c:=0, flag=true,
x=true, y=true</label>
			<nail x="-119" y="59"/>
			<nail x="-51" y="59"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="guard" x="-8" y="-93">flag &amp;&amp; c&gt;=100</label>
			<label kind="assignment" x="-8" y="-68">s=false, flag=false,
u=true, v=true,
gc:=0</label>
			<nail x="-17" y="-109"/>
			<nail x="-17" y="1"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="guard" x="-212" y="-93">c&gt;=100</label>
			<label kind="assignment" x="-263" y="-68">s=true, l=true,
m=true, h=true,
u=false, v=false</label>
			<nail x="-161" y="-109"/>
			<nail x="-161" y="1"/>
		</transition>
	</template>
	<template>
		<name x="5" y="5">System</name>
		<declaration>//局部时钟
clock c;</declaration>
		<location id="id1" x="-544" y="-221">
			<name x="-554" y="-255">Init</name>
			<label kind="invariant" x="-561" y="-212">c&lt;=5</label>
		</location>
		<location id="id2" x="-519" y="-93">
			<name x="-536" y="-127">Waste</name>
		</location>
		<location id="id3" x="-357" y="-221">
			<name x="-391" y="-255">CheckDevices</name>
			<label kind="invariant" x="-374" y="-212">c&lt;=20</label>
		</location>
		<location id="id4" x="-451" y="-221">
			<name x="-493" y="-255">CheckSensors</name>
			<label kind="invariant" x="-468" y="-212">c&lt;=10</label>
		</location>
		<location id="id5" x="-646" y="-221">
			<name x="-656" y="-255">Idle</name>
		</location>
		<location id="id6" x="-171" y="-220">
			<name x="-197" y="-254">Prepared</name>
			<urgent/>
		</location>
		<location id="id7" x="25" y="-220">
			<name x="-1" y="-254">FeedingA</name>
			<label kind="invariant" x="8" y="-212">c&lt;=20</label>
		</location>
		<location id="id8" x="-69" y="-220">
			<name x="-103" y="-254">CheckLowLL</name>
			<urgent/>
		</location>
		<location id="id9" x="161" y="-93">
			<name x="144" y="-85">FeedingB</name>
			<label kind="invariant" x="144" y="-67">c&lt;=20</label>
		</location>
		<location id="id10" x="-264" y="-93">
			<name x="-306" y="-127">CheckQuality</name>
			<urgent/>
		</location>
		<location id="id11" x="-391" y="1">
			<name x="-417" y="18">Product</name>
		</location>
		<location id="id12" x="42" y="-93">
			<name x="-1" y="-127">CheckHighLL</name>
			<urgent/>
		</location>
		<location id="id13" x="-128" y="-297">
			<name x="-161" y="-331">Evacuation</name>
			<label kind="invariant" x="-153" y="-289">c&lt;=5000</label>
		</location>
		<location id="id14" x="305" y="-220">
			<name x="271" y="-254">Intervention</name>
			<label kind="invariant" x="289" y="-204">c&lt;=5000</label>
		</location>
		<location id="id15" x="161" y="-220">
			<name x="118" y="-254">CheckMediumLL</name>
			<urgent/>
		</location>
		<location id="id16" x="93" y="-297">
			<name x="76" y="-331">Reset</name>
			<committed/>
		</location>
		<location id="id17" x="-519" y="1">
			<name x="-553" y="18">Discharge</name>
		</location>
		<location id="id18" x="-119" y="-93">
			<name x="-153" y="-127">PQInspection</name>
			<label kind="invariant" x="-136" y="-84">c&lt;=50</label>
		</location>
		<location id="id19" x="-646" y="-93">
			<name x="-663" y="-127">End</name>
			<committed/>
		</location>
		<location id="id20" x="-646" y="1">
			<name x="-688" y="18">CheckLowLL2</name>
			<urgent/>
		</location>
		<init ref="id5"/>
		<transition>
			<source ref="id19"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="-731" y="-186">Stop?</label>
			<nail x="-714" y="-152"/>
		</transition>
		<transition>
			<source ref="id19"/>
			<target ref="id5"/>
			<label kind="assignment" x="-671" y="-170">flag=false</label>
		</transition>
		<transition>
			<source ref="id20"/>
			<target ref="id19"/>
			<label kind="guard" x="-663" y="-76">!l</label>
			<label kind="assignment" x="-757" y="-59">v=false, u=false,
z=false, w=0, q=0,
flag=true</label>
		</transition>
		<transition>
			<source ref="id20"/>
			<target ref="id17"/>
			<label kind="guard" x="-578" y="35">l</label>
			<nail x="-621" y="52"/>
			<nail x="-544" y="52"/>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id20"/>
			<label kind="select" x="-604" y="-16">lf2:int[0,1]</label>
			<label kind="assignment" x="-587" y="1">l=lf2</label>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id17"/>
			<label kind="assignment" x="-501" y="0">h=false, m=false</label>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id17"/>
			<label kind="assignment" x="-570" y="-76">h=false,
m=false</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id11"/>
			<label kind="guard" x="-357" y="-68">q&gt;=90</label>
			<label kind="assignment" x="-382" y="-51">u=true</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id2"/>
			<label kind="guard" x="-467" y="-136">q&gt;=70 &amp;&amp; q&lt;90 
&amp;&amp; gc&gt;=inspectionTime</label>
			<label kind="assignment" x="-425" y="-93">v=true</label>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id18"/>
			<label kind="guard" x="-297" y="-42">q&gt;=70 &amp;&amp; q&lt;90 &amp;&amp; gc&lt;inspectionTime</label>
			<label kind="assignment" x="-212" y="-25">flag=true</label>
			<nail x="-264" y="-42"/>
			<nail x="-119" y="-42"/>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="356" y="-382">Stop?</label>
			<nail x="-51" y="-42"/>
			<nail x="390" y="-42"/>
			<nail x="390" y="-365"/>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id10"/>
			<label kind="select" x="-230" y="-110">qf:int[70,100]</label>
			<label kind="guard" x="-213" y="-127">c&gt;=30</label>
			<label kind="assignment" x="-221" y="-93">c:=0, q=qf,
flag=false</label>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id18"/>
			<label kind="guard" x="-43" y="-110">h</label>
			<label kind="assignment" x="-94" y="-93">y=false, gc:=0, c:=0,
         flag=true</label>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id9"/>
			<label kind="guard" x="118" y="-152">!h</label>
			<label kind="assignment" x="51" y="-153">flag=true</label>
			<nail x="67" y="-135"/>
			<nail x="127" y="-135"/>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="322" y="-314">Stop?</label>
			<nail x="356" y="-93"/>
			<nail x="356" y="-297"/>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id14"/>
			<label kind="guard" x="51" y="-17">gc&gt;=feedingTime &amp;&amp; !h</label>
			<label kind="assignment" x="212" y="-17">c:=0, flag=false</label>
			<nail x="42" y="-16"/>
			<nail x="305" y="-16"/>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id12"/>
			<label kind="select" x="76" y="-110">hf:int[0,1]</label>
			<label kind="guard" x="84" y="-127">c&gt;=10</label>
			<label kind="assignment" x="68" y="-93">c:=0, h=hf,
flag=false</label>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id16"/>
			<label kind="synchronisation" x="25" y="-280">Stop?</label>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id13"/>
			<label kind="assignment" x="-59" y="-357">x=false, y=false,
u=false, v=true,
q=0, c:=0</label>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id16"/>
			<label kind="guard" x="238" y="-289">c&gt;=5000</label>
			<nail x="306" y="-263"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id5"/>
			<label kind="guard" x="-314" y="-297">c&gt;=5000</label>
			<label kind="assignment" x="-493" y="-314">v=false, z=false, w=0,
l=false, m=false, h=false</label>
			<nail x="-536" y="-297"/>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id9"/>
			<label kind="guard" x="170" y="-195">m</label>
			<label kind="assignment" x="170" y="-178">x=false, y=true,
z=true, w=100,
gc:=0, c:=0,
flag=true</label>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id7"/>
			<label kind="guard" x="34" y="-178">!m</label>
			<label kind="assignment" x="59" y="-178">flag=true</label>
			<nail x="127" y="-161"/>
			<nail x="25" y="-161"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id6"/>
			<label kind="guard" x="-85" y="-161">!l</label>
			<label kind="assignment" x="-153" y="-161">flag=true</label>
			<nail x="-69" y="-161"/>
			<nail x="-171" y="-161"/>
		</transition>
		<transition>
			<source ref="id15"/>
			<target ref="id14"/>
			<label kind="guard" x="178" y="-221">gc&gt;=feedingTime 
         &amp;&amp; !m</label>
			<label kind="assignment" x="212" y="-238">c:=0</label>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id15"/>
			<label kind="select" x="59" y="-237">mf:int[0,1]</label>
			<label kind="guard" x="67" y="-254">c&gt;=10</label>
			<label kind="assignment" x="59" y="-221">c:=0, m=mf,
flag=false</label>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id7"/>
			<label kind="guard" x="-26" y="-237">l</label>
			<label kind="assignment" x="-51" y="-221">x=true,
flag=true,
gc:=0,
c:=0</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id8"/>
			<label kind="select" x="-145" y="-237">lf:int[0,1]</label>
			<label kind="assignment" x="-144" y="-221">l=lf,
flag=false</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="-417" y="-339">Stop?</label>
			<nail x="-230" y="-322"/>
			<nail x="-570" y="-322"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id6"/>
			<label kind="guard" x="-324" y="-220">gc&gt;=preheatingTime</label>
			<label kind="assignment" x="-297" y="-238">flag=true</label>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id1"/>
			<label kind="guard" x="-426" y="-178">c&gt;=15</label>
			<label kind="assignment" x="-511" y="-178">c:=0</label>
			<nail x="-451" y="-152"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id3"/>
			<label kind="guard" x="-425" y="-238">c&gt;=7</label>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id4"/>
			<label kind="guard" x="-519" y="-238">c&gt;=3</label>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="-621" y="-238">Start?</label>
			<label kind="assignment" x="-621" y="-221">gc:=0,
c:=0</label>
		</transition>
	</template>
	<system>// Place template instantiations here.
//Process = System();
// List one or more processes to be composed into a system.
system Admin;
    </system>
	<queries>
		<query>
			<formula>A[] not deadlock</formula>
			<comment>系统可用性（1） R13 验证系统是否存在死锁，以确保整个系统的访问与使用未被恶意代码破坏</comment>
		</query>
		<query>
			<formula></formula>
			<comment></comment>
		</query>
		<query>
			<formula>A[] gc&gt;=feedingTime</formula>
			<comment>活性约束（3） R12 时间约束，当任意进料口在进料容错时间内仍未触发液位传感器，说明进料口出现异常，必须人工干预</comment>
		</query>
		<query>
			<formula>!s --&gt; !x and !y and !u and !v</formula>
			<comment>活性约束（3） R11 当总开关关闭时，所有阀门都将关闭（废料阀在排空后关闭）</comment>
		</query>
		<query>
			<formula>E&lt;&gt; s and (u or v)</formula>
			<comment>活性约束（3） R10 当总开关打开时，至少有一个排料阀会打开</comment>
		</query>
		<query>
			<formula></formula>
			<comment></comment>
		</query>
		<query>
			<formula>A[] u imply q&gt;=90</formula>
			<comment>逻辑约束（4） R9 当产品阀打开时，产品质量必须合格</comment>
		</query>
		<query>
			<formula>A[] (l and m and h) imply q&gt;=70</formula>
			<comment>逻辑约束（4） R8 当到达高液位时，产检传感器必须随时检测产品质量</comment>
		</query>
		<query>
			<formula>A[] (l and m) imply !x</formula>
			<comment>逻辑约束（4） R7 当到达中液位时，进料口A必须关闭</comment>
		</query>
		<query>
			<formula>A[] !l imply (!u and !v)</formula>
			<comment>逻辑约束（4） R6 当低于低液位时，所有排料阀必须关闭</comment>
		</query>
		<query>
			<formula></formula>
			<comment></comment>
		</query>
		<query>
			<formula>A[] y imply w==100</formula>
			<comment>冲突约束（4） R5 一旦进料口B打开，搅拌器必须启动</comment>
		</query>
		<query>
			<formula>A[] !((x or y) and (u or v))</formula>
			<comment>冲突约束（4） R4 任意进料口与任意排料阀不能同时打开</comment>
		</query>
		<query>
			<formula>A[] !(u and v)</formula>
			<comment>冲突约束（4） R3 产品阀和废品阀不能同时打开</comment>
		</query>
		<query>
			<formula>A[] !(x and y)</formula>
			<comment>冲突约束（4） R2 进料口A和进料口B不能同时打开</comment>
		</query>
		<query>
			<formula></formula>
			<comment></comment>
		</query>
		<query>
			<formula>A[] w==0 or w==100</formula>
			<comment>阈值约束（1） R1 搅拌器转速只能是0或100</comment>
		</query>
	</queries>
</nta>
